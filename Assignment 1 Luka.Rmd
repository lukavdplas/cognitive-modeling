---
title: 'Lab assignment 1: Processing models'
author: "Luka van der Plas (4119142) & Rianne Lam (6888216)"
date: "15 november 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Question 1A

```{r q1A, echo=FALSE}
load("keyPressDataWithLaneDeviation.Rdata")

no_errors <- subset(keyPressDataWithLaneDeviation, typingErrorMadeOnTrial == 0)
finished_dialling <- subset(no_errors, phoneNrLengthAfterKeyPress == 11)

mean_sd_se <- function(data){
  #summarise data into mean, SD and SE
 mean_value <- mean(data)
 sd <- sd(data)
 se <- sd / sqrt(length(data))
 
 c(mean_value, sd, se)
}

summarise <- function(dialling_data) {
  #calculate mean per participant
  mean_dialling_times <- aggregate(dialling_data[, c('pp', 'timeRelativeToTrialStart')], by = list(dialling_data$pp), FUN = mean)$timeRelativeToTrialStart
  
  #get summary over all participants
  summary <- mean_sd_se(mean_dialling_times)
  summary
}

#data per condition
steer_focus <-  summarise(subset(finished_dialling, partOfExperiment == 'dualSteerFocus'))
dial_focus <- summarise(subset(finished_dialling, partOfExperiment == 'dualDialFocus'))
    
```

Table:

```{r table_q1a}


```

### Question 1B

```{r q1b, echo=FALSE}


avg_deviation_per_trial <- function(n, data) {
  trial_data = subset(data, trial == n)
  mean_absolute_deviation <- mean(abs(trial_data$lanePosition))
  
  mean_absolute_deviation
}

avg_deviation_over_condition <- function(condition) {
  data <- subset(keyPressDataWithLaneDeviation,  partOfExperiment == condition)
  deviations <- c()
  p_count <- max(data$pp)
  for (p in 1:p_count) {
    p_data <- subset(data, pp == p)
    trials <- unique(p_data$trial)
    for (t in trials) {
      mean_deviation <- avg_deviation_per_trial(t, p_data)
      deviations <- append(deviations, mean_deviation)
    }
  }
  mean_sd_se(deviations)
}

dual_steer_data <- avg_deviation_over_condition('dualSteerFocus')
dual_dial_data <- avg_deviation_over_condition('dualDialFocus')

```


###Question 1C

```{r q1c, echo=FALSE}


keypresses = unique(keyPressDataWithLaneDeviation$phoneNrLengthAfterKeyPress)

avg_deviation_per_digit <- function(data) {
  #calculate average of deviation for each digit
  results <- numeric(length(keypresses))
  for(i in keypresses){
    key_data <- subset(data, phoneNrLengthAfterKeyPress == i)
    deviation <- mean(abs(key_data$lanePosition))
    results[i] <- deviation
  }
  results
}

total_digits <- length(keypresses)

digit_deviations_per_condition <- function(condition) {
  data <- subset(keyPressDataWithLaneDeviation, partOfExperiment == condition)
  
  #framework for deviations: a list with the data for each digit
  deviations <- list()
  for (i in keypresses){
    deviations <- append(deviations, list(c()))
  }
  
  #calculate deviation data per participant ...
  p_count <- max(data$pp)
  for (p in 1:p_count) {
    p_data <- subset(data, pp == p)
    
    #... and per trial
    trials <- unique(p_data$trial)
    for (t in trials) {
      #get deviation data per digit
      t_data <- subset(p_data, trial == t)
      trial_deviations <- avg_deviation_per_digit(t_data)
      
      #store in deviations list
      for (i in 1:total_digits){
        deviations[[i]] <- append(deviations[[i]], trial_deviations[i])
      }
    }
  }
  
  #compute mean and SD per digit
  means <- numeric(length=length(keypresses))
  sds <- numeric(length=length(keypresses))
  
  for (i in 1:length(keypresses)) {
    means[i] <- mean(deviations[[i]], na.rm=TRUE)
    sds[i] <- sd(deviations[[i]], na.rm=TRUE)
  }
  
  #put everything in a dataframe
  condition_col <- rep(condition, length(keypresses))
  df <- data.frame(keypresses, means, sds, condition_col)
  
  return(df)
  
}

dual_steer_data_per_digit <- digit_deviations_per_condition('dualSteerFocus')
dual_dial_data_per_digit <- digit_deviations_per_condition('dualDialFocus')

plot_data <- rbind(dual_dial_data_per_digit, dual_steer_data_per_digit)

```

### Question 1D

### Question 2A

```{r q2a, echo=FALSE}

library(ggplot2)
load("tableOfDriftValuesCalibration.Rdata")


driftdata <- subset(tableOfDriftValuesCalibration, trialTime >= 15000 & trialTime <= 18000)
driftdata$trial <- as.factor(driftdata$trial)

ggplot(driftdata, aes(trialTime, posX)) +
  geom_line(aes(group = trial, color = trial)) +
  theme(legend.position = "none")


```

### Question 2B

```{r q2b, echo=FALSE}

#get trials and timesteps
trials <- unique(tableOfDriftValuesCalibration$trial)
timesteps <- 3000 / 50
timerange <- seq(0, 3000, 50)

#empty df
trial_data <- data.frame()

#add data for trials
for (t in trials) {
  deviations <- rnorm(timesteps, mean = 0, sd = 0.13)
  deviations <- cumsum(deviations)
  
  for (i in 1:length(deviations)) {
    trial_data <- rbind(trial_data, c(t, timerange[i], deviations[i]))
  }
}

#set column names
colnames(trial_data) <- c("trial", "time", "deviation")
trial_data$trial <- as.factor(trial_data$trial)

ggplot(trial_data, aes(time, deviation)) +
  geom_line(aes(group = trial, color = trial)) +
  theme(legend.position = "none")

```


### Question 2C

```{r q2c, echo=FALSE}

min_pos <- min(min(driftdata$posX), min(trial_data$deviation))
min_pos <- floor(min_pos * 10) / 10
max_pos <- max(max(driftdata$posX), max(trial_data$deviation))
max_pos <- ceiling(max_pos * 10) / 10

ggplot(driftdata, aes(posX)) +
  geom_histogram(binwidth = 0.2) +
  scale_x_continuous(breaks = seq(min_pos, max_pos, 0.2)) +
  coord_cartesian(xlim=  c(min_pos, max_pos), ylim=c(0, 350)) +
  xlab("lateral position") +
  ylab("frequency")

ggplot(trial_data, aes(deviation)) +
  geom_histogram(binwidth = 0.2) +
  scale_x_continuous(breaks = (breaks = seq(min_pos, max_pos, 0.2))) +
  coord_cartesian(xlim=  c(min_pos, max_pos), ylim=c(0, 350)) +
  xlab("lateral position") +
  ylab("frequency")


```


### Question 2D

```{r q2d, echo=FALSE}

measured_sd <- sd(driftdata$posX)
simulated_sd <- sd(trial_data$deviation)

table <- data.frame("Source" = c("Measured", "Simulated"), "SD" = c(measured_sd, simulated_sd))

print(table)

```

### Question 2E

To find the optimal SD value, we searched through SD values from 0.01 to 0.13, with a step of 0.01. For each SD value, we calculated the standard deviation of the lateral position over 50 trials, and then calculated the absolute difference with the target SD, i.e. the one measured on the human trials. Below is a plot with these results.

```{r q2e}


sim_data_with_sd <- function(sd_value, trialN = 50) {
  #empty df for new simulatin
  new_sim <- data.frame()
  
  trials <- seq(trialN)
  #add data for trials
  for (t in trials) {
    deviations <- rnorm(timesteps, mean = 0, sd = sd_value)
    deviations <- cumsum(deviations)
    
    for (i in 1:length(deviations)) {
      new_sim <- rbind(new_sim, c(t, timerange[i], deviations[i]))
    }
  }
  
  colnames(new_sim) <- c("trial", "time", "deviation")
  new_sim$trial <- as.factor(new_sim$trial)
  
  new_sim
}

get_sd_result <- function(sd_value) {
  sim <- sim_data_with_sd(sd_value)
  sd_result <- sd(sim$deviation)
  sd_result
}

get_differences <- function(sd_value) {
  diff <- abs(sd_value - measured_sd)
  diff
}


sds <- seq(from  = 0.01, to = 0.13, by = 0.01)
sd_results <- sapply(sds, FUN = get_sd_result)
sd_differences <- sapply(sd_results, FUN = get_difference)

sds_df <- data.frame("SD" = sds, "Difference" <- differences)

ggplot(sds_df, aes(SD, Difference)) + 
  geom_line() + 
  scale_x_continuous(breaks = sds)

```

Based on these results, we chose to use an SD for the gaussian distribution of 0.07. This gives an SD of lateral position of 0.344.

```{r q2e_2, echo=FALSE}

opt_sd = 0.07

#20 trials
sim_data <- sim_data_with_sd(opt_sd, trialN = 20)

#plot deviation
ggplot(sim_data, aes(time, deviation)) +
  geom_line(aes(group = trial, color = trial)) +
  theme(legend.position = "none")
```

```{r q2e_3, echo=FALSE}

ggplot(sim_data, aes(deviation)) +
  geom_histogram(binwidth = 0.2) +
  scale_x_continuous(breaks = (breaks = seq(min_pos, max_pos, 0.2))) +
  coord_cartesian(xlim=  c(min_pos, max_pos), ylim=c(0, 350)) +
  xlab("lateral position") +
  ylab("frequency")

```

