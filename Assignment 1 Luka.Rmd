---
title: 'Lab assignment 1: Processing models'
author: "Luka van der Plas (4119142) & Rianne Lam (6888216)"
date: "15 november 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Question 1A

```{r q1A, echo=FALSE}
load("keyPressDataWithLaneDeviation.Rdata")

no_errors <- subset(keyPressDataWithLaneDeviation, typingErrorMadeOnTrial == 0)
finished_dialling <- subset(no_errors, phoneNrLengthAfterKeyPress == 11)

mean_sd_se <- function(data){
  #summarise data into mean, SD and SE
 mean_value <- mean(data)
 sd <- sd(data)
 se <- sd / sqrt(length(data))
 
 c(mean_value, sd, se)
}

summarise <- function(dialling_data) {
  #calculate mean per participant
  mean_dialling_times <- aggregate(dialling_data[, c('pp', 'timeRelativeToTrialStart')], by = list(dialling_data$pp), FUN = mean)$timeRelativeToTrialStart
  
  #get summary over all participants
  summary <- mean_sd_se(mean_dialling_times)
  summary
}

#data per condition
steer_focus <-  summarise(subset(finished_dialling, partOfExperiment == 'dualSteerFocus'))
dial_focus <- summarise(subset(finished_dialling, partOfExperiment == 'dualDialFocus'))
    
```

Table:

```{r table_q1a}


```

### Question 1B

```{r q1b, echo=FALSE}


avg_deviation_per_trial <- function(n, data) {
  trial_data = subset(data, trial == n)
  mean_absolute_deviation <- mean(abs(trial_data$lanePosition))
  
  mean_absolute_deviation
}

avg_deviation_over_condition <- function(condition) {
  data <- subset(keyPressDataWithLaneDeviation,  partOfExperiment == condition)
  deviations <- c()
  p_count <- max(data$pp)
  for (p in 1:p_count) {
    p_data <- subset(data, pp == p)
    trials <- unique(p_data$trial)
    for (t in trials) {
      mean_deviation <- avg_deviation_per_trial(t, p_data)
      deviations <- append(deviations, mean_deviation)
    }
  }
  mean_sd_se(deviations)
}

dual_steer_data <- avg_deviation_over_condition('dualSteerFocus')
dual_dial_data <- avg_deviation_over_condition('dualDialFocus')

```


###Question 1C

```{r q1c, echo=FALSE}


keypresses = unique(keyPressDataWithLaneDeviation$phoneNrLengthAfterKeyPress)

avg_deviation_per_digit <- function(data) {
  #calculate average of deviation for each digit
  results <- numeric(length(keypresses))
  for(i in keypresses){
    key_data <- subset(data, phoneNrLengthAfterKeyPress == i)
    deviation <- mean(abs(key_data$lanePosition))
    results[i] <- deviation
  }
  results
}

total_digits <- length(keypresses)

digit_deviations_per_condition <- function(condition) {
  data <- subset(keyPressDataWithLaneDeviation, partOfExperiment == condition)
  
  #framework for deviations: a list with the data for each digit
  deviations <- list()
  for (i in keypresses){
    deviations <- append(deviations, list(c()))
  }
  
  #calculate deviation data per participant ...
  p_count <- max(data$pp)
  for (p in 1:p_count) {
    p_data <- subset(data, pp == p)
    
    #... and per trial
    trials <- unique(p_data$trial)
    for (t in trials) {
      #get deviation data per digit
      t_data <- subset(p_data, trial == t)
      trial_deviations <- avg_deviation_per_digit(t_data)
      
      #store in deviations list
      for (i in 1:total_digits){
        deviations[[i]] <- append(deviations[[i]], trial_deviations[i])
      }
    }
  }
  
  #compute mean and SD per digit
  means <- numeric(length=length(keypresses))
  sds <- numeric(length=length(keypresses))
  
  for (i in 1:length(keypresses)) {
    means[i] <- mean(deviations[[i]], na.rm=TRUE)
    sds[i] <- sd(deviations[[i]], na.rm=TRUE)
  }
  
  #put everything in a dataframe
  condition_col <- rep(condition, length(keypresses))
  df <- data.frame(keypresses, means, sds, condition_col)
  
  return(df)
  
}

dual_steer_data_per_digit <- digit_deviations_per_condition('dualSteerFocus')
dual_dial_data_per_digit <- digit_deviations_per_condition('dualDialFocus')

plot_data <- rbind(dual_dial_data_per_digit, dual_steer_data_per_digit)

```

### Question 1D

### Question 2A

```{r q2a, echo=FALSE}

library(ggplot2)
load("tableOfDriftValuesCalibration.Rdata")


driftdata <- subset(tableOfDriftValuesCalibration, trialTime >= 15000 & trialTime <= 18000)
driftdata$trial <- as.factor(driftdata$trial)

ggplot(driftdata, aes(trialTime, posX)) +
  geom_line(aes(group = trial, color = trial)) +
  theme(legend.position = "none")


```

### Question 2B

```{r q2b, echo=FALSE}

#get trials and timesteps
trials <- unique(tableOfDriftValuesCalibration$trial)
timesteps <- 3000 / 50
timerange <- seq(0, 3000, 50)

#empty df
trial_data <- data.frame()

#add data for trials
for (t in trials) {
  deviations <- rnorm(timesteps, mean = 0, sd = 0.13)
  deviations <- cumsum(deviations)
  
  for (i in 1:length(deviations)) {
    trial_data <- rbind(trial_data, c(t, timerange[i], deviations[i]))
  }
}

#set column names
colnames(trial_data) <- c("trial", "time", "deviation")
trial_data$trial <- as.factor(trial_data$trial)

ggplot(trial_data, aes(time, deviation)) +
  geom_line(aes(group = trial, color = trial)) +
  theme(legend.position = "none")

```


### Question 2C

```{r q2c, echo=FALSE}

min_pos <- min(min(driftdata$posX), min(trial_data$deviation))
min_pos <- floor(min_pos * 10) / 10
max_pos <- max(max(driftdata$posX), max(trial_data$deviation))
max_pos <- ceiling(max_pos * 10) / 10

ggplot(driftdata, aes(posX)) +
  geom_histogram(binwidth = 0.2) +
  scale_x_continuous(breaks = seq(min_pos, max_pos, 0.2)) +
  coord_cartesian(xlim=  c(min_pos, max_pos), ylim=c(0, 350)) +
  xlab("lateral position") +
  ylab("frequency")

ggplot(trial_data, aes(deviation)) +
  geom_histogram(binwidth = 0.2) +
  scale_x_continuous(breaks = (breaks = seq(min_pos, max_pos, 0.2))) +
  coord_cartesian(xlim=  c(min_pos, max_pos), ylim=c(0, 350)) +
  xlab("lateral position") +
  ylab("frequency")


```


### Question 2D

```{r q2d, echo=FALSE}

measured_sd <- sd(driftdata$posX)
simulated_sd <- sd(trial_data$deviation)

table <- data.frame("Source" = c("Measured", "Simulated"), "SD" = c(measured_sd, simulated_sd))

print(table)

```

### Question 2E

To find the optimal SD value, we searched through SD values from 0.01 to 0.13, with a step of 0.01. For each SD value, we calculated the standard deviation of the lateral position over 50 trials, and then calculated the absolute difference with the target SD, i.e. the one measured on the human trials. Below is a plot with these results.

```{r q2e}


sim_data_with_sd <- function(sd_value, trialN = 50) {
  #empty df for new simulatin
  new_sim <- data.frame()
  
  trials <- seq(trialN)
  #add data for trials
  for (t in trials) {
    deviations <- rnorm(timesteps, mean = 0, sd = sd_value)
    deviations <- cumsum(deviations)
    
    for (i in 1:length(deviations)) {
      new_sim <- rbind(new_sim, c(t, timerange[i], deviations[i]))
    }
  }
  
  colnames(new_sim) <- c("trial", "time", "deviation")
  new_sim$trial <- as.factor(new_sim$trial)
  
  new_sim
}

get_sd_result <- function(sd_value) {
  sim <- sim_data_with_sd(sd_value)
  sd_result <- sd(sim$deviation)
  sd_result
}

get_differences <- function(sd_value) {
  diff <- abs(sd_value - measured_sd)
  diff
}


sds <- seq(from  = 0.01, to = 0.13, by = 0.01)
sd_results <- sapply(sds, FUN = get_sd_result)
sd_differences <- sapply(sd_results, FUN = get_differences)

sds_df <- data.frame("SD" = sds, "Difference" <- differences)

ggplot(sds_df, aes(SD, Difference)) + 
  geom_line() + 
  scale_x_continuous(breaks = sds)

```

Based on these results, we chose to use an SD for the gaussian distribution of 0.07. This gives an SD of lateral position of 0.344.

```{r q2e_2, echo=FALSE}

opt_sd = 0.07

#20 trials
sim_data <- sim_data_with_sd(opt_sd, trialN = 20)

#plot deviation
ggplot(sim_data, aes(time, deviation)) +
  geom_line(aes(group = trial, color = trial)) +
  theme(legend.position = "none")
```

```{r q2e_3, echo=FALSE}

ggplot(sim_data, aes(deviation)) +
  geom_histogram(binwidth = 0.2) +
  scale_x_continuous(breaks = (breaks = seq(min_pos, max_pos, 0.2))) +
  coord_cartesian(xlim=  c(min_pos, max_pos), ylim=c(0, 350)) +
  xlab("lateral position") +
  ylab("frequency")

```

### Question 3A

We changed the gaussDeviateSD in the driving model to 0.07 for drifting, and the gaussDriveNoiseSD to 0.053, to preserve the ratio between the two parameters.

```{r q3, echo=FALSE}

data <- subset(no_errors, partOfExperiment == "singleDialing2")

all_times <- c()

#loop through trials and participants
participants <- unique(data$pp)
for (p in participants) {
  p_data <- subset(data, pp ==p)
  trials <- unique(p_data$trial)
  for(t in trials) {
  #compute average keypress interval time over data
  t_data <- subset(p_data, trial == t)
  #the final time is just the total
  total_time <- max(t_data$timeRelativeToTrialStart)
  n <- (length(t_data$timeRelativeToTrialStart) - 1) #substract one from the length because there are n + 1 datapoints.
  if (n > 0) {
    avg_keypress_time <- total_time / n
    all_times <- c(all_times, c(avg_keypress_time))
    }
  }
}

#compute mean
mean_keypress_time <- mean(all_times)

```

The average keypress time is 272.5 ms.

###Question 3B

We picked a value of 275 ms, because that amount of rounding seemed acceptable.


###Question 4A
 
 For 1 simulation:
 
```{r q4a1, echo=FALSE}

source("drivingModel.R")

#ex_trial <- runOneTrial(c(), 5, c(1,6), 11, "07854325698")
#ex_trial <- runOneTrial(c(4,5), 5, c(1,6), 11, "07854325698")

correlations <- data.frame()

corr <- runAllSimpleStrategies(1, "07854325698")
correlations <- rbind(correlations, c(1, corr))

```

For 5 simulations:
 
```{r q4a2, echo=FALSE}

corr <- runAllSimpleStrategies(5, "07854325698")
correlations <- rbind(correlations, c(5, corr))
```



For 10 simulations:
 
```{r q4a3, echo=FALSE}

corr <- runAllSimpleStrategies(10, "07854325698")
correlations <- rbind(correlations, c(10, corr))
```


For 50 simulations:
 
```{r q4a4, echo=FALSE}

corr <- runAllSimpleStrategies(50, "07854325698")
correlations <- rbind(correlations, c(50, corr))
```

```{r q4a5, echo=FALSE}

corr <- runAllSimpleStrategies(100, "07854325698")
correlations <- rbind(correlations, c(100, corr))
```


```{r q4a6, echo=FALSE}

corr <- runAllSimpleStrategies(200, "07854325698")
correlations <- rbind(correlations, c(200, corr))
```



### Question 4B
The data show that results become less noisy with more simulations: the range of total deviation is smaller and data show a clear downward trend between deviation and dial time. We wanted to quantify this result: a clearer trend with fewer outliers will give a stronger correlation between dialing time and deviation. This correlation is plotter for all simulation counts below.

```{r q4b, echo=FALSE}

colnames(correlations) <- c("N", "timeDeviationCorrelation")

ggplot(correlations, aes(N, timeDeviationCorrelation)) +
  geom_line()

```

We estimate that the 50 simulations should work well in development: they do not take a very long time to run, but already show a clear trend in the data. The correlation plot shows that after 50 simulations, the amount of trend is not changing that much anymore.
It may be good to use 100 simulations when gathering final results about the final model, since the data still show a clearer correlation for 100 simulations. However, there is almost no increase between 100 and 200.

### Question 5A

```{r q5a}


generate_strategies <- function(n) {
  #give all strategies of length n
  
  #base case
  if (n ==1) {
    return (matrix(c(FALSE, TRUE)))
  }
    
  #recursive definition
  tail <- generate_strategies(n - 1)
  count <- dim(tail)[1]
  
  start_0 <- cbind(matrix(rep(FALSE, count)), tail)
  start_1 <- cbind(matrix(rep(TRUE, count)), tail)
  
  return(rbind(start_0, start_1))
}

all_strategies <- generate_strategies(10)

give_breakpoints <- function(strat) {
  breakpoints <- c()
  
  for (i in 1:length(strat)) {
    if (strat[i]) {
      breakpoints <- c(breakpoints, c(i))
    }
  }
  breakpoints
}

steeringTimeOptions <- c(2,4,6,8,10,12)

runAllComplexStrategies <- function(nrSimulations,phoneNumber) {
	
	
	normalPhoneStructure <- c(1,6)  ### indicate at what digit positions a chunk needs to be retrieved (1st and 6th digit)
	phoneStringLength <- 11   ### how many digits does the number have?
	

	### vectors that will contain output of the simulation. These are later used to create 1 table with all values
	keypresses <- c()
	times <- c()
	deviations <- c()
	strats <- c()
	steers <- c()	

	### iterate through all strategies
	## in this simple model we assume that a participant uses a consistent strategy throughout the trial. That is, they only type each time 1 digit, or type 2 digits at a time, or type 3 digits at a time (i.e., all possible ways of 1:phoneStringLength: 1, 2,3,4, ...11)
	
	for (i in 1:10) #(i in 1:nrow(all_strategies))
	{
		## quick way of calculating positions to interleave: repeat strategy & multiply with position in vector (e.g., 333*123 = 369 this means: you interleave BEFORE every 3rd digit (333), and there are 3 positions to interleave (1st, 2nd, 3rd, or 123). Therefore you interleave BEFORE digits 3 (3*1), 6 (3*2), and 9 (3*3))
	  
	  strategy <- give_breakpoints(all_strategies[i,])
		

		locSteerTimeOptions <- steeringTimeOptions
		if (length(strategy) == 0)
		{
			locSteerTimeOptions <- c(0)
		}



		### now run a trial (runOneTrial) for all combinations of how frequently you update the steering when you are steering (locSteerTimeOptions) and for the nuber of simulations that you want to run for each strategy (nrSimulations)
		for (steerTimes in locSteerTimeOptions)
		{
			for (i in 1:nrSimulations)
			{

				### run the simulation and store the output in a table
				locTab <- runOneTrial(strategy, steerTimes,normalPhoneStructure,phoneStringLength,phoneNumber)
	
				##only look at rows where there is a keypress
				locTab <- locTab[locTab$events == "keypress",]
		
				### add the relevant data points to variables that are stored in a final table
				keypresses <- c(keypresses,1:nrow(locTab))
				times <- c(times,locTab$times)
				deviations <- c(deviations,locTab$drifts)
				strats <- c(strats,rep(i,nrow(locTab)))
				steers <- c(steers,rep(steerTimes,nrow(locTab)))
		
			}
		}#end of for steerTimes	

	}##end of for nr strategies
	
	
	### now make a new table based on all the data that was collected
	tableAllSamples <- data.frame(keypresses,times,deviations,strats,steers)
	
	tableAllSamples
}

```

```{r q5a1}

runAllComplexStrategies(1, "07854325698")
```